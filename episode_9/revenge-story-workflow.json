{
  "name": "Episode 9: Revenge story creator",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -220,
        -3120
      ],
      "id": "a85a6597-e9a1-445f-b22b-7015402e3a26",
      "name": "When clicking ‘Test workflow’"
    },
    {
      "parameters": {
        "fieldToSplitOut": "data.children",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        340,
        -3120
      ],
      "id": "7fd00466-4e3f-49fd-92de-1aea0bbac0d5",
      "name": "Split Out"
    },
    {
      "parameters": {
        "model": "qwen3:32b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmOllama",
      "typeVersion": 1,
      "position": [
        340,
        -3760
      ],
      "id": "66f9af13-f6fd-424b-8ae6-55bad8af3348",
      "name": "Ollama Model",
      "credentials": {
        "ollamaApi": {
          "id": "cWXUsJ0LsqnzOEx0",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        920,
        -3120
      ],
      "id": "78b4ee9b-c229-4a44-ab07-c6de99f77b16",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "9daf2cb4-cbd3-433e-bb54-69036c29ccd8",
              "leftValue": "={{ $json.data.is_video }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        600,
        -3120
      ],
      "id": "ca658516-8955-4168-a128-8cb2ccec6221",
      "name": "Filter"
    },
    {
      "parameters": {
        "tableId": "revenge_stories",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "reddit_id",
              "fieldValue": "={{ $('Set fields').item.json.reddit_id }}"
            },
            {
              "fieldId": "title",
              "fieldValue": "={{ $('Set fields').item.json.title }}"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('Set fields').item.json.content }}"
            },
            {
              "fieldId": "permalink",
              "fieldValue": "={{ $('Set fields').item.json.permalink }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "skipped"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2900,
        -2800
      ],
      "id": "79d9adf8-7533-4091-940c-e8c7fa3a78d8",
      "name": "Skip post",
      "credentials": {
        "supabaseApi": {
          "id": "ITjsOe1zjbHScIWk",
          "name": "Supabase revange videos"
        }
      }
    },
    {
      "parameters": {
        "tableId": "revenge_stories",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "reddit_id",
              "fieldValue": "={{ $('Set fields').item.json.reddit_id }}"
            },
            {
              "fieldId": "title",
              "fieldValue": "={{ $('Set fields').item.json.title }}"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('Set fields').item.json.content }}"
            },
            {
              "fieldId": "permalink",
              "fieldValue": "={{ $('Set fields').item.json.permalink }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "queued"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2580,
        -2800
      ],
      "id": "4b153f9b-dc12-412a-8a29-d88ce85333dd",
      "name": "Save post",
      "credentials": {
        "supabaseApi": {
          "id": "ITjsOe1zjbHScIWk",
          "name": "Supabase revange videos"
        }
      }
    },
    {
      "parameters": {
        "inputText": "={{ $('Set fields').item.json.title }}\n\n{{ $('Set fields').item.json.content }}",
        "categories": {
          "categories": [
            {
              "category": "story"
            },
            {
              "category": "ask_for_advice"
            },
            {
              "category": "ranting"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.textClassifier",
      "typeVersion": 1,
      "position": [
        2100,
        -3100
      ],
      "id": "b493e70e-5b81-4c7f-a215-7ee462fe2c16",
      "name": "Is it a story?"
    },
    {
      "parameters": {
        "url": "https://www.reddit.com/r/revengestories/top.json?t=month&limit=100",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        20,
        -3120
      ],
      "id": "5e826a0e-f0ea-4c06-bcc5-daa3dea860df",
      "name": "Get stories from Reddit"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2c779eb8-420e-431f-9d77-fea1ecd728c4",
              "name": "content",
              "value": "={{ $json.data.selftext }}",
              "type": "string"
            },
            {
              "id": "103089b2-22c8-4d90-8aba-2e9bb8989b8f",
              "name": "title",
              "value": "={{ $json.data.title }}",
              "type": "string"
            },
            {
              "id": "4d57755f-aa41-49fe-8d12-f309cdacdab8",
              "name": "permalink",
              "value": "={{ $json.data.permalink }}",
              "type": "string"
            },
            {
              "id": "9f2b8c7f-aa30-455f-a6d6-df7937213603",
              "name": "reddit_id",
              "value": "={{ $json.data.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1380,
        -3120
      ],
      "id": "3684de24-5db0-45f6-92ab-4e51b33a029a",
      "name": "Set fields"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "revenge_stories",
        "filters": {
          "conditions": [
            {
              "keyName": "reddit_id",
              "keyValue": "={{ $json.reddit_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1640,
        -3120
      ],
      "id": "7dca3c40-fa2a-4a9c-9cfe-3d8063ae6bd4",
      "name": "Look up the id of the post",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ITjsOe1zjbHScIWk",
          "name": "Supabase revange videos"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6d9626e6-2605-4b45-8550-cf1c972e681f",
              "leftValue": "={{ $json.keys().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1860,
        -3120
      ],
      "id": "cddbeaf0-646c-4c2b-9994-e23585a4941e",
      "name": "Already exists?"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "revenge_stories",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "status",
              "condition": "eq",
              "keyValue": "queued"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        920,
        -1740
      ],
      "id": "451aa784-1e49-42f6-987e-27d62f89f978",
      "name": "Get the next story to process",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "ITjsOe1zjbHScIWk",
          "name": "Supabase revange videos"
        }
      }
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        460,
        -760
      ],
      "id": "4197fb12-5181-4b41-94a5-bb9dccb3260d",
      "name": "Wait",
      "webhookId": "6e8a282a-9ef0-4c3d-b4dd-d4ca41366446"
    },
    {
      "parameters": {
        "url": "={{ $('Setup the download url').item.json.download_url }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2040,
        -1080
      ],
      "id": "a4838968-b3a5-49db-ae56-9cdb18a02931",
      "name": "Download the video",
      "alwaysOutputData": false,
      "retryOnFail": false,
      "disabled": true
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "upload",
        "title": "={{ $('Generate video').item.json.output.videoTitle }}",
        "regionCode": "HU",
        "categoryId": "24",
        "options": {}
      },
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [
        2280,
        -1080
      ],
      "id": "6a73d69b-2d06-4572-bb55-314d48c09641",
      "name": "Share on YouTube",
      "disabled": true
    },
    {
      "parameters": {
        "url": "={{ $('Configuration for story writing').item.json.server_url }}/api/videos/{{ $('Start creating the video').item.json.video_id }}/status",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        680,
        -760
      ],
      "id": "30a011e7-4dcd-463c-b8cf-2a08824ba188",
      "name": "Check video status",
      "alwaysOutputData": false,
      "retryOnFail": false
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Configuration for story writing').item.json.server_url }}/api/videos",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $('Cleanup text').item.json.text }}"
            },
            {
              "name": "person_image_url",
              "value": "={{ $('Create character').item.json.output.sex === \"male\" ? $('Configuration for story writing').item.json.person_male_image_url : $('Configuration for story writing').item.json.person_female_image_url }}"
            },
            {
              "name": "person_name",
              "value": "={{ $('Create character').item.json.output.name }}"
            },
            {
              "name": "bg_video_url",
              "value": "={{ $('Configuration for story writing').item.json.bg_video_url }}"
            },
            {
              "name": "voice",
              "value": "={{ $('Set the final voice').item.json.voice }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        20,
        -760
      ],
      "id": "5b3cfb99-781f-4745-9682-a2ef205fd971",
      "name": "Start creating the video"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "failed",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "6ff9c638-d9b5-41d1-977e-0b1521476d1a"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "failed"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a656c56d-40e2-4a42-ac1b-5bd09654f9af",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "processing",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "processing"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45b9a8da-0a03-4ae0-86f2-a631264e1d55",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "completed",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completed"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        940,
        -760
      ],
      "id": "5395584d-28d2-470a-b8ac-55ba53bd8c32",
      "name": "Switch"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1500,
        -1060
      ],
      "id": "64895f22-34bd-4be7-a7a6-cc18d2014ba9",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "761be6c7-4a57-4c29-b24b-0e7769515baf",
              "name": "text",
              "value": "={{ $json.text.split('</think>')[1].trim().replace(/\\n/g, '').replace(/ {2,}/g, ' ').replace(/\\*/g, '') }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2140,
        -1740
      ],
      "id": "56c8bb6c-f100-467f-b44a-f27f85975528",
      "name": "Cleanup text"
    },
    {
      "parameters": {
        "text": "=<sex>{{ $('Setup sex of the main character').item.json.sex }}</sex>\n<reddit_revenge_story>\n<title>{{ $('Get the next story to process').item.json.title }}</title>\n<content>\n{{ $('Get the next story to process').item.json.content }}\n</content>\n</reddit_revenge_story>",
        "attributes": {
          "attributes": [
            {
              "name": "name",
              "description": "the name of the main character",
              "required": true
            },
            {
              "name": "age",
              "type": "number",
              "description": "the age of the main character",
              "required": true
            },
            {
              "name": "location",
              "description": "the location of the main character",
              "required": true
            },
            {
              "name": "sex",
              "description": "the sex of the main character",
              "required": true
            }
          ]
        },
        "options": {
          "systemPromptTemplate": "=You are an expert writer.\nCreate a new, fictionalized character and the back story based on the reddit story.\nDon't use any name or location from the story, create a new ones.\nUse the provided sex for the character.\n\nThe final story wil be written in {{ $('Setup language').item.json.language }} ({{ $('Configuration for story writing').item.json.lang_code }}) language, so make sure the location and the name are authentic for the language."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        1440,
        -1740
      ],
      "id": "0d33f56e-957c-47f7-bbbf-1122c1da83f1",
      "name": "Create character"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "revenge_stories",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "reddit_id",
              "condition": "eq",
              "keyValue": "={{ $('Get the next story to process').item.json.reddit_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "created"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1740,
        -740
      ],
      "id": "e13beed6-5e8a-4890-aea3-40b9fc21a235",
      "name": "Set status to created",
      "credentials": {
        "supabaseApi": {
          "id": "ITjsOe1zjbHScIWk",
          "name": "Supabase revange videos"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "revenge_stories",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "reddit_id",
              "condition": "eq",
              "keyValue": "={{ $('Get the next story to process').item.json.reddit_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "uploaded"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2580,
        -740
      ],
      "id": "0acd45ff-340c-4be1-8e9a-e3910789a0bb",
      "name": "Set status to uploaded",
      "credentials": {
        "supabaseApi": {
          "id": "ITjsOe1zjbHScIWk",
          "name": "Supabase revange videos"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "revenge_stories",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "reddit_id",
              "condition": "eq",
              "keyValue": "={{ $('Get the next story to process').item.json.reddit_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "failed"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1280,
        -1060
      ],
      "id": "9d064092-54ba-4a51-8c4a-eac40145565a",
      "name": "Set status to failed",
      "credentials": {
        "supabaseApi": {
          "id": "ITjsOe1zjbHScIWk",
          "name": "Supabase revange videos"
        }
      }
    },
    {
      "parameters": {
        "content": "# Add more stories to the database",
        "height": 940,
        "width": 3600
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -420,
        -3380
      ],
      "id": "a973c25f-9151-4924-b581-3fbfa29f00f7",
      "name": "Sticky Note"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1480,
        -2060
      ],
      "id": "d306d19c-124d-4cb4-895f-dfcdf4281021",
      "name": "No unprocessed stories in the database"
    },
    {
      "parameters": {
        "url": "={{ $('Configuration for story writing').item.json.server_url }}/api/languages",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "hello world"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3020,
        -1580
      ],
      "id": "95ea7117-5b8e-4ed8-875d-7dbf217136d6",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "64863f3c-916c-4799-a01a-f057ea9bd619",
              "name": "sex",
              "value": "={{ $('Configuration for story writing').item.json.sex || $('Configuration for story writing').item.json.lang_code === 'fr' ? 'female' : ['male', 'female'].randomItem() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        640,
        -1740
      ],
      "id": "e93dabb8-e238-4a29-8110-a052ddc1b378",
      "name": "Setup sex of the main character"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "48869e0b-b79b-4ff9-8777-ca0b66a4199b",
              "name": "bg_video_url",
              "value": "={{ [\"https://xfkwoofhjjnbduauwnns.supabase.co/storage/v1/object/public/revenge-stories-assets/bgvideo.mp4\"].randomItem() }}",
              "type": "string"
            },
            {
              "id": "f50ea6b3-78cc-448a-8bc2-551c3d9fc10c",
              "name": "person_female_image_url",
              "value": "={{ [\"https://xfkwoofhjjnbduauwnns.supabase.co/storage/v1/object/public/revenge-stories-assets/person_female.png\"].randomItem() }}",
              "type": "string"
            },
            {
              "id": "424ad55a-479a-4e96-bd79-20b88e5e44ab",
              "name": "person_male_image_url",
              "value": "={{ [\"https://xfkwoofhjjnbduauwnns.supabase.co/storage/v1/object/public/revenge-stories-assets/person_male.png\"].randomItem() }}",
              "type": "string"
            },
            {
              "id": "efa00bce-d84c-450a-ae7e-41cbf4ffdda8",
              "name": "server_url",
              "value": "http://192.168.68.60:8000",
              "type": "string"
            },
            {
              "id": "5b5a9281-1de3-429e-aaf3-8da03a38b979",
              "name": "lang_code",
              "value": "en-gb",
              "type": "string"
            },
            {
              "id": "e37a6d43-b329-488b-ac91-98a4bba0b1cb",
              "name": "voice",
              "value": "",
              "type": "string"
            },
            {
              "id": "63752d0d-90a8-400a-9162-07dff0f3490d",
              "name": "sex",
              "value": "female",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        20,
        -1740
      ],
      "id": "242c8f06-72f6-48a1-94ac-cc4ec106f39e",
      "name": "Configuration for story writing"
    },
    {
      "parameters": {
        "jsCode": "const languages = {\n  \"en-us\": \"english\",\n  \"en-gb\": \"english\",\n  \"zh\": \"simplified chinese\",\n  \"es\": \"spanish\",\n  \"fr\": \"french\",\n  \"it\": \"italian\",\n  \"pt\": \"brazilian portugese\"\n}\n\nconst language = languages[$('Configuration for story writing').item.json.lang_code];\n\nreturn {\n  language\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        360,
        -1740
      ],
      "id": "7bdf4290-038e-4525-a345-e9ef4b4d4311",
      "name": "Setup language"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d156f819-15ca-4510-bfa9-8ebb0b8db611",
              "name": "voice",
              "value": "={{ $json.voice }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3720,
        -1580
      ],
      "id": "6827003c-2716-4948-b13d-2b7a09b49e34",
      "name": "Set the final voice"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ec9bcc50-398a-48b3-a32b-bf847868b9b3",
              "leftValue": "={{ $('Configuration for story writing').item.json.voice }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2520,
        -1740
      ],
      "id": "a444f01a-5236-46f3-9bc3-d1fab10e84e1",
      "name": "Is there a pre-selected voice to use?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4160cb90-6045-4ebd-ac07-24c6240d87d9",
              "name": "voice",
              "value": "={{ $('Configuration for story writing').item.json.voice }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3100,
        -1860
      ],
      "id": "1d2570b8-b26c-477c-a62c-885a5ff65794",
      "name": "Keep the original voice value"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ae921e13-ea42-4f6c-b997-f9e502f190fb",
              "name": "voice",
              "value": "={{ \n\n$json[$('Configuration for story writing').item.json.lang_code].map(item => ({ voice: item, sex: item.split('_')[0][1]})).filter(item => item.sex === ($('Create character').item.json.output.sex === 'female' ? 'f' : 'm')).randomItem().voice\n\n}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3200,
        -1580
      ],
      "id": "21a172d0-0eae-40ac-804e-9055f610c2ad",
      "name": "Set a random voice"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "29f1f743-befd-4901-b645-da092ae64021",
              "leftValue": "={{ $json.keys().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1180,
        -1740
      ],
      "id": "3d8013e6-08cb-40f1-9ca9-0be9c0a32c3a",
      "name": "Is there a story to process?"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=I'm creating a revenge story video from revenge stories shared on Reddit. Your task is take the input, enhance it and create an engaging, fictionalized revenge story from it.\n\n<instructions>\n1. Use the plot structure below to create the story\n2. Use the provided character name, age, sex and location. Make sure to customize the story so it fits the sex of the character.\n3. The story should be told in first person\n4. Make the reading level 8th grade\n5. Don't use acronyms, use the long version of every turn. The text will be used turned into speech with TTS.\n6. Don't create paragraphs, don't format the text, use clear and continous text\n7. The story should be very long\n8. Write the story in {{ $('Setup language').item.json.language }} ({{ $('Configuration for story writing').item.json.lang_code }}) language. Make sure it sounds authentic.\n\nPlot structure\n\n- **Act 1: The character is in a situation with a problem.**\n    - Introduce the character, their world, and their place in it. What is interesting or intriguing about this character and their life? Describe any distinctive qualities, and create empathy with them.\n    - Something happens to shake the character’s world, or they find themselves in a new situation, creating a threat or opportunity. What problem does the character have to solve? How is the character unsatisfied with how things currently are? Who has appeared as their nemesis?\n- **Act 2: They try to solve the problem, but fail, making it worse.**\n    - Character begins to make efforts to solve their problem. They face a series of hurdles or conflicts, each of increasing difficulty and stakes. Some they win, some they lose. The original problem begins to grow bigger and more serious.\n    - In order for the high of the climax to have the greatest effect, take the character as low as they can go. Despite all the progress they’ve made against external and internal obstacles, something should happen which makes them certain that all may be lost.\n- **Act 3: They make a final attempt to solve the problem, which may succeed or fail. The consequence is not always as expected.**\n    - Bring to a climax. The character makes a final, last ditch effort to solve their problem. They must dig deep to find that last bit of strength and courage, and risk everything they have to make one final attempt. May involve a confrontation between the character and their nemesis.\n    - Depending on the type of story being written, this effort can solve the problem or destroy everything. The consequences of their choice must be poetic. In vast majority of cases, the character is rewarded for their action or decision and be fulfilled.\n    - Bring to a resolution. Show the character’s new normal, how they may have changed, and tie up any loose ends. As close to the end as possible, there could be an unexpected twist to leave a parting thrill.\n</instructions>\n\n<character>\n<name>{{ $json.output.name }}</name>\n<age>{{ $json.output.age }}</age>\n<location>{{ $json.output.location }}</location>\n<sex>{{ $json.output.sex }}</sex>\n</character>\n\n<reddit_revenge_story>\n<title>{{ $('Get the next story to process').item.json.title }}</title>\n<content>\n{{ $('Get the next story to process').item.json.content }}\n</content>\n</reddit_revenge_story>",
        "messages": {
          "messageValues": [
            {
              "message": "=You are an expert creative writer. You write revenge stories for a living."
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        1780,
        -1740
      ],
      "id": "d29267f6-65cd-49b3-a406-5e8fe3343ee4",
      "name": "Write the story"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "00a93563-0016-45c5-a651-22b3e529c51c",
              "name": "download_url",
              "value": "={{ $('Configuration for story writing').item.json.server_url }}/api/videos/{{ $('Start creating the video').item.json.video_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1480,
        -740
      ],
      "id": "5415ef3b-c896-4cbb-a739-78511abbca87",
      "name": "Setup the download url"
    },
    {
      "parameters": {
        "content": "# Select an LLM model",
        "height": 600,
        "width": 1000,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -420,
        -4120
      ],
      "id": "0c179610-cef6-4f59-a204-b5fd349bb1a4",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -140,
        -3940
      ],
      "id": "73ff609c-f2fc-4937-aa0e-feb47d4daa2e",
      "name": "OpenRouter Chat Model"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        20,
        -3760
      ],
      "id": "96902f9a-3c7b-40a4-9540-8249c19fff86",
      "name": "Google Gemini Chat Model"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -320,
        -3940
      ],
      "id": "65e2fbe6-b007-4717-9b76-bee0c513f545",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "tGvJRP2th9CbI2oq",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAzureOpenAi",
      "typeVersion": 1,
      "position": [
        -320,
        -3760
      ],
      "id": "0b04564a-b228-4c34-aece-3ddfe3a2331b",
      "name": "Azure OpenAI Chat Model"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatXAiGrok",
      "typeVersion": 1,
      "position": [
        -140,
        -3760
      ],
      "id": "d9b0d547-8544-4bf9-916b-7371a9de715f",
      "name": "xAI Grok Chat Model"
    },
    {
      "parameters": {
        "content": "# Create a story, generate a video and upload to YouTube",
        "height": 1880,
        "width": 4420,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -420,
        -2300
      ],
      "id": "caf8d1fb-cab3-41fc-8051-9c7dd26af071",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "# Configure me!",
        "height": 440,
        "width": 260,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -40,
        -1900
      ],
      "id": "d7555f8e-9199-4e7c-b412-27e29a63aedd",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "# [Watch the video on YouTube](https://youtu.be/ttt9da4f1wM)\n\n# [Read the guides on how to setup Supabase, start and use the server](https://github.com/gyoridavid/ai_agents_az/blob/main/episode_9)\n\n# [Need help? Join the Discord server](https://discord.gg/G7FJVJQ6RE)",
        "height": 580,
        "width": 1240
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        720,
        -4100
      ],
      "id": "52bb677f-73ae-4540-9edd-eb9fd4dcc724",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "# 1. Make sure to add a trigger node to both of the workflows\n\n# 2. Feel free to separate these workflows\n",
        "height": 800,
        "width": 640,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1120,
        -2740
      ],
      "id": "59fdc886-f8a5-4938-9da1-73bd548aa3d7",
      "name": "Sticky Note5"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking ‘Test workflow’": {
      "main": [
        [
          {
            "node": "Get stories from Reddit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Model": {
      "ai_languageModel": [
        [
          {
            "node": "Is it a story?",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Write the story",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Create character",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Set fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip post": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save post": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is it a story?": {
      "main": [
        [
          {
            "node": "Save post",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip post",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Skip post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get stories from Reddit": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set fields": {
      "main": [
        [
          {
            "node": "Look up the id of the post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Look up the id of the post": {
      "main": [
        [
          {
            "node": "Already exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Already exists?": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is it a story?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get the next story to process": {
      "main": [
        [
          {
            "node": "Is there a story to process?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Check video status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download the video": {
      "main": [
        [
          {
            "node": "Share on YouTube",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check video status": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start creating the video": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Set status to failed",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Setup the download url",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cleanup text": {
      "main": [
        [
          {
            "node": "Is there a pre-selected voice to use?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Operation, do nothing": {
      "main": [
        []
      ]
    },
    "Create character": {
      "main": [
        [
          {
            "node": "Write the story",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Share on YouTube": {
      "main": [
        [
          {
            "node": "Set status to uploaded",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set status to created": {
      "main": [
        [
          {
            "node": "Download the video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set status to failed": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Set a random voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup sex of the main character": {
      "main": [
        [
          {
            "node": "Get the next story to process",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configuration for story writing": {
      "main": [
        [
          {
            "node": "Setup language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup language": {
      "main": [
        [
          {
            "node": "Setup sex of the main character",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set the final voice": {
      "main": [
        [
          {
            "node": "Start creating the video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is there a pre-selected voice to use?": {
      "main": [
        [
          {
            "node": "Keep the original voice value",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Keep the original voice value": {
      "main": [
        [
          {
            "node": "Set the final voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set a random voice": {
      "main": [
        [
          {
            "node": "Set the final voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is there a story to process?": {
      "main": [
        [
          {
            "node": "Create character",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No unprocessed stories in the database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Write the story": {
      "main": [
        [
          {
            "node": "Cleanup text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup the download url": {
      "main": [
        [
          {
            "node": "Set status to created",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e4159f19-d920-48a1-b4c2-0d911ef90c6e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "636db6b6ab21a21c6458e2137f340e33dc3e49f5a1c560c8d1e2372c227cf40e"
  },
  "id": "2yetvBGqqsH9DQLB",
  "tags": []
}